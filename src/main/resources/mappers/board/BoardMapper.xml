<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team5.projrental.board.BoardMapper">
    <insert id="insBoard" useGeneratedKeys="true" keyProperty="iboard" keyColumn="iboard">
        INSERT INTO board
        SET title = #{title}
        , contents = #{contents}
    </insert>

    <insert id="insBoardPics" useGeneratedKeys="true" keyProperty="ipics">
        INSERT INTO board_pic
        SET
        <foreach collection="pics" item="pic" open="(" close=")" separator=",">
            stored_pic = #{storedPic}
        </foreach>
    </insert>

    <select id="selBoardList">
        SELECT A.nick, B.title, B.iboard, B.view
        , B.created_at AS createdAt
        , if(C.iuser is null, 0, 1) AS isLiked
        FROM user A
        JOIN board B
        ON A.iuser = B.iuser
        <choose>
            <when test="sort == 1">
                INNER JOIN board_like C
            </when>
            <when test="sort == 0 or sort == 2">
                LEFT JOIN board_like C
            </when>
        </choose>
        ON B.iboard = C.board_iboard
        <choose>
            <when test="sort == 0 or sort == 1">
                ORDER BY B.iboard DESC
            </when>
            <when test="sort == 2">
                ORDER BY B.view DESC
            </when>
        </choose>
        LIMIT #{startIdx}, #{rowCount}
    </select>

    <select id="selBoard">
        SELECT A.nick, A.stored_pic, B.iboard
        , B.title, B.contents, B.view, B.created_at, if(C.iuser is null, 0, 1) AS isLiked
        FROM user A
        JOIN board B
        ON A.iuser = B.iuser
        LEFT JOIN board_like C
        ON B.iboard = C.board_iboard
        WHERE B.iboard = #{iboard}
        LIMIT #{startIdx}, #{rowCount}
    </select>

    <!-- 특정 게시글의 사진들 -->
    <select id="selBoardPicList">
        SELECT stored_pic
        FROM board_pic
        WHERE iboard = #{iboard}
    </select>

    <!-- 조회수 -->
    <update id="viewCount" parameterType="int">
        UPDATE board
        SET view = view + 1
        WHERE iboard = #{iboard};
    </update>

    <!-- 게시글 수정 -->
    <update id="putBoard">
        UPDATE board
        SET title = #{title}
        , content = #{content}
        WHERE iboard = #{iboard}
    </update>

    <!-- 게시글의 사진 수정 -->
    <update id="putBoardPic">
        UPDATE board_pic
        SET
        <foreach collection="pic" item="pic" open="(" close=")" separator=",">
            stored_pic = #{storedPic}
        </foreach>
        WHERE iboard = #{iboard}
    </update>

    <!-- 게시글 삭제(숨김) -->
    <update id="delBoard">
        UPDATE board
        SET status = #{status}
        WHERE iboard = #{iboard}
    </update>

    <insert id="insLike">
        INSERT INTO board_like
        SET board_iboard = #{iboard}
        and iuser = #{loginIuser}
    </insert>

    <delete id="delLike">
        DELETE FROM board_like
        WHERE board_iboard = #{iboard}
        and iuser = #{loginIuser}
    </delete>

    <select id="selLike">
        select iuser, board_iboard AS iboard
        from board_like
        where iuser = #{iuser}
        and board_iboard = #{iboard}
    </select>

</mapper>